name: Build Samsung Galaxy Tab S9 WiFi (Lineage OS 22.1 A15)

on:
  workflow_call:
  workflow_dispatch:

env:
  # Device env
  DEVICE_NAME: "samsung_galaxy_tab_s9wifi"
  DEVICE_CODENAME: "gts9wifi"

  CUSTOM_CMDS: "CLANG_TRIPLE=aarch64-linux-gnu-"
  EXTRA_CMDS: "LD=ld.lld LLVM=1 LLVM_IAS=1"

  KERNEL_SOURCE: "https://github.com/samsung-sm8550-tab/android_kernel_samsung_sm8550.git"
  KERNEL_BRANCH: "android15-stable"

  CLANG_SOURCE: "https://github.com/llvm/llvm-project/releases/download/llvmorg-20.1.8/LLVM-20.1.8-Linux-X64.tar.xz"
  CLANG_BRANCH: ""

  GCC_GNU: false
  GCC_64_SOURCE: "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9.git"
  GCC_64_BRANCH: "android12L-release"
  GCC_32_SOURCE: "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9.git"
  GCC_32_BRANCH: "android12L-release"

  DEFCONFIG_SOURCE: ""
  DEFCONFIG_NAME: "gki_defconfig"
  DEFCONFIG_ORIGIN_IMAGE: ""
  DEFCONFIG_FROM_BOOT: false

  USE_GKI : true

  KERNELSU_ENABLE : true

  KERNELSU_SOURCE: "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh"
  KERNELSU_BRANCH: "builtin"

  KERNELSU_AUTO_GET: "false" # if u want easy setting kernelsu, u can true.
  KERNELSU_AUTO_FORK: "sukisu" # magic, rsuntk, next, wild, jingmatrix and sukisu

  SUSFS_ENABLE: true
  SUSFS_FIXED: false
  SUSFS_BRANCH : "gki-android13-5.15" # only GKI needs it.

  AK3_SOURCE: "https://github.com/YuzakiKokuban/AnyKernel3.git"
  AK3_BRANCH: "kalama_tab"

  BOOT_SOURCE: ""

  NEED_DTBO: false
  NEED_SAFE_DTBO: false

  ROM_TEXT: "los22.1_a15_5.15"

  # Other env
  PYTHON_VERSION: "3" # Only 2(Ubuntu 22.04 and Ubuntu 20.04) or 3(Any OS Versions).

  PACK_METHOD: "Anykernel3" # Anykernel3 need SOURCE and BRANCH, MKBOOTIMG needn't it.

  KERNELSU_METHOD: "shell" # shell, manual and only.

  PATCHES_SOURCE: "mzwing/NonGKI_Kernel_Patches" # [your_name]/[your_patch] -> gooder123/NonGKI_Patcher
  PATCHES_BRANCH: "samsung_kernel" # [your_branch] -> main

  SUSFS_FOLDER_FIXED: "gts9wifi_sm8550" # Fill in your patch prefix directory here. Leave it blank if there isn't one. -> your_folder
  SUSFS_PATCH_FIXED: "" # Fill in your patches here. If there are multiple patches, please separate them with a comma. Leave it blank if there isn't one. -> patch1,patch2

  REKERNEL_ENABLE: "false" # if u need Re:Kernel.

  HOOK_METHOD: "syscall" # manual hook method,can choice : normal, syscall and tracepoint.
  HOOK_OLDER: "false" # contain backport older patch and syscall older patch.

  KPM_ENABLE: "false" # Only use it for SukiSU-Ultra.
  KPM_PATCH_SOURCE: "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU_patch/refs/heads/main/kpm/patch_linux" # patch exec file source -> raw.githubusercontent.com/Test/Test/patch .

  BASEBAND_GUARD_ENABLE: "true" #if u want prevent unauthorized writes to critical partitions/device nodes.
  BASEBAND_GUARD_BOOT: "false" #if u want to protect boot partition.

  HIDE_STUFF: "true" # hide some of the features

  GENERATE_DTB: "false" # if u kernel need DTB , but cannot auto generate it. (Only Anykernel3).
  GENERATE_CHIP: "qcom" # only supported for qcom and mediatek.

  BUILD_DEBUGGER: "true" # Output build errors.
  SKIP_PATCH: "true" # Ignore errors found in Patch Debugger.

  BUILD_OTHER_CONFIG: "true" # Merge config files.
  MERGE_CONFIG_FILES: "kalama_le_gki.fragment"

  FREE_MORE_SPACE: "true" # if u want get more space, enabled it.

  SETUP_SWAP: "true" # if u want setup swap space, enabled it. Note that FREE_MORE_SPACE must also be true to avoid storage lack.

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest # u can changed to ubuntu 22.04, and need container set ubuntu-latest
    # container: archlinux/archlinux:latest # if u need use arch linux -> archlinux/archlinux:latest or ubuntu 20.04 -> ubuntu:focal
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: â° Checkout repository
        uses: actions/checkout@v4

      - name: âŒ›ï¸ Compilation environment preparation
        uses: ./.github/workflows/build-env

      - name: âš™ï¸ Get neccssary tools
        uses: ./.github/workflows/build-ready

      - name: ğŸª Patch Kernel of SUSFS
        uses: ./.github/workflows/patch-susfs

      - name: ğŸ”— Patch for no-kprobe
        uses: ./.github/workflows/patch-no-kprobe

      - name: ğŸ§Š Set Swap Space
        uses: ./.github/workflows/setup-swap

      - name: ğŸª› Extra Kernel Options
        run: |
          # Only ${{ env.DEVICE_NAME }} use it.
          cd $GITHUB_WORKSPACE/device_kernel

          # Enable Tmpfs for mountify module
          echo "CONFIG_TMPFS_XATTR=y" >> ./arch/${{ env.KERNEL_ARCH }}/configs/${{ env.DEFCONFIG_NAME }}
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./arch/${{ env.KERNEL_ARCH }}/configs/${{ env.DEFCONFIG_NAME }}

          # Enable ReSukiSU Multi Manager Support
          echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> ./arch/${{ env.KERNEL_ARCH }}/configs/${{ env.DEFCONFIG_NAME }}

          # Fix libelf.h not found
          sudo apt-get install -y libelf-dev

          # Fix BTF issue (pahole is not available)
          sed -i '/CONFIG_DEBUG_INFO_BTF=y/d' ./arch/${{ env.KERNEL_ARCH }}/configs/${{ env.DEFCONFIG_NAME }}

          # Fix undefined symbol _stack_chk_guard
          echo "KBUILD_CFLAGS += -fno-stack-protector" >> ./Makefile

          # Enable O2 Optimization
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./arch/${{ env.KERNEL_ARCH }}/configs/${{ env.DEFCONFIG_NAME }}

      - name: ğŸ§° Patch Kernel of Re:Kernel
        uses: ./.github/workflows/patch-rekernel

      - name: ğŸ”’ Patch Kernel of Baseband Guard
        uses: ./.github/workflows/patch-baseband-guard

      - name: ğŸ”§ Patch Hide Stuff
        uses: ./.github/workflows/patch-hide-stuff

      - name: ğŸš€ Build Process
        uses: ./.github/workflows/build-process

      - name: ğŸ”© Pack Process
        uses: ./.github/workflows/pack-process

      - name: âœï¸ Upload Artifacts
        uses: ./.github/workflows/upload-files
