name: Build Samsung Note 10 (OneUI A15)

on:
  workflow_call:
  workflow_dispatch:

env:
  # Device env
  DEVICE_NAME : "samsung_note_10"
  DEVICE_CODENAME : "d1"

  CUSTOM_CMDS : "CLANG_TRIPLE=aarch64-linux-gnu-"
  EXTRA_CMDS : "LLVM=1 LLVM_IAS=1"

  KERNEL_SOURCE : "https://github.com/JackA1ltman/ExtremeKernel_noksu.git"
  KERNEL_BRANCH : "main"

  CLANG_SOURCE : "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman"
  CLANG_BRANCH : ""

  GCC_GNU : false
  GCC_64_SOURCE : ""
  GCC_64_BRANCH : ""
  GCC_32_SOURCE : ""
  GCC_32_BRANCH : ""

  DEFCONFIG_SOURCE: ""
  DEFCONFIG_NAME : "exynos9820_defconfig"
  DEFCONFIG_ORIGIN_IMAGE: ""
  DEFCONFIG_FROM_BOOT: false

  KERNELSU_SOURCE : "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/refs/heads/susfs-main/kernel/setup.sh"
  KERNELSU_BRANCH : "susfs-main"

  KERNELSU_AUTO_GET : "false"
  KERNELSU_AUTO_FORK : "" # magic, rsuntk , next and sukisu

  SUSFS_ENABLE : true
  SUSFS_FIXED : true
  SUSFS_UPDATE : true

  AK3_SOURCE : "https://github.com/osm0sis/AnyKernel3.git"
  AK3_BRANCH : "master"

  BOOT_SOURCE : ""

  NEED_DTBO : false
  NEED_SAFE_DTBO : false

  ROM_TEXT : "oneui_a15"

  # Other env
  PYTHON_VERSION: "3" # Only 2(Ubuntu 22.04 and Ubuntu 20.04) or 3(Any OS Versions).

  PACK_METHOD: "Anykernel3" # Anykernel3 need SOURCE and BRANCH, MKBOOTIMG needn't it.

  KERNELSU_METHOD: "shell" # shell, manual and only.

  PATCHES_SOURCE: "JackA1ltman/NonGKI_Kernel_Patches" # [your_name]/[your_patch] -> gooder123/NonGKI_Patcher
  PATCHES_BRANCH: "samsung_kernel" # [your_branch] -> main

  SUSFS_FOLDER_FIXED: "note10_plus_exyons9850" # Fill in your patch prefix directory here. Leave it blank if there isn't one. -> your_folder
  SUSFS_155_FIXED: "susfs_155_fixed" # Fill in your patches here. If there are multiple patches, please separate them with a comma. Leave it blank if there isn't one. -> patch1,patch2 (Only v1.5.5 SuSFS)
  SUSFS_LATEST_FIXED: "susfs_158_fixed,susfs_1510_fixed,susfs_1511_fixed" # Fill in your patches here. If there are multiple patches, please separate them with a comma. Leave it blank if there isn't one. -> patch1,patch2

  REKERNEL_ENABLE: "false" # if u need Re:Kernel.

  HOOK_METHOD: "tracepoint" # manual hook method,can choice : normal, syscall and tracepoint.
  HOOK_OLDER: "false" # contain backport older patch and syscall older patch.

  KPM_ENABLE: "false" # Only use it for SukiSU-Ultra.
  KPM_PATCH_SOURCE: "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU_patch/refs/heads/main/kpm/patch_linux" # patch exec file source -> raw.githubusercontent.com/Test/Test/patch .

  BASEBAND_GUARD_ENABLE: "false" #if u want prevent unauthorized writes to critical partitions/device nodes.
  BASEBAND_GUARD_BOOT: "false" #if u want to protect boot partition.

  GENERATE_DTB: "false" # if u kernel need DTB , but cannot auto generate it. (Only Anykernel3).
  GENERATE_CHIP: "qcom" # only supported for qcom and mediatek.

  BUILD_DEBUGGER: "false" # Output build errors.
  SKIP_PATCH: "false" # Ignore errors found in Patch Debugger.

  BUILD_OTHER_CONFIG: "true" # Merge config files.
  MERGE_CONFIG_FILES: "d1.config"

  FREE_MORE_SPACE: "false" # if u want get more space, enabled it.

jobs:
  build-kernel:
    name: Samsung Note 10 (OneUI A15)
    runs-on: ubuntu-latest # u can changed to ubuntu 22.04, and need container set ubuntu-latest
    # container: archlinux/archlinux:latest # if u need use arch linux -> archlinux/archlinux:latest or ubuntu 20.04 -> ubuntu:focal
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: â° Checkout repository
        uses: actions/checkout@v4

      - name: âŒ›ï¸ Compilation environment preparation
        uses: ./.github/workflows/build-env

      - name: âš™ï¸ Get neccssary tools
        uses: ./.github/workflows/build-ready

      - name: ğŸª Patch Kernel of SUSFS
        uses: ./.github/workflows/patch-susfs

      - name: ğŸ”— Patch for no-kprobe
        uses: ./.github/workflows/patch-no-kprobe

      - name: ğŸª› Extra Kernel Options
        run: |
          # Only ${{ env.DEVICE_NAME }} use it.
          cd $GITHUB_WORKSPACE/device_kernel
          # Nothing

      - name: ğŸ§° Patch Kernel of Re:Kernel
        uses: ./.github/workflows/patch-rekernel

      - name: ğŸ”’ Patch Kernel of Baseband Guard
        uses: ./.github/workflows/patch-baseband-guard

      - name: ğŸš€ Build Process
        uses: ./.github/workflows/build-process

      - name: â— Samsung Kernel Pack Process
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE/device_kernel

          # Var
          TIME=$(date +"%Y%m%d%H%M%S")
          KERNEL_PATH=build/out/d1/Image
          KERNEL_OFFSET=0x00008000
          RAMDISK_OFFSET=0xF0000000
          SECOND_OFFSET=0xF0000000
          TAGS_OFFSET=0x00000100
          BASE=0x10000000
          CMDLINE='loop.max_part=7'
          HASHTYPE=sha1
          HEADER_VERSION=1
          OS_PATCH_LEVEL=2025-01
          OS_VERSION=14.0.0
          PAGESIZE=2048
          RAMDISK=build/out/d1/ramdisk.cpio.gz
          OUTPUT_FILE=build/out/d1/boot.img
          BOARD=SRPSD26B009KU

          mkdir -p build/out/d1/zip/files
          mkdir -p build/out/d1/zip/META-INF/com/google/android

          cp -f out/arch/arm64/boot/Image build/out/d1/Image

          ./toolchain/mkdtimg cfg_create build/out/d1/dtb.img build/dtconfigs/exynos9825.cfg -d out/arch/arm64/boot/dts/exynos
          ./toolchain/mkdtimg cfg_create build/out/d1/dtbo.img build/dtconfigs/d1.cfg -d out/arch/arm64/boot/dts/samsung

          pushd build/ramdisk > /dev/null
          find . ! -name . | LC_ALL=C sort | cpio -o -H newc -R root:root | gzip > ../out/d1/ramdisk.cpio.gz || abort
          popd > /dev/null

          ./toolchain/mkbootimg --base $BASE --board $BOARD --cmdline "$CMDLINE" --hashtype $HASHTYPE --header_version $HEADER_VERSION --kernel $KERNEL_PATH --kernel_offset $KERNEL_OFFSET --os_patch_level $OS_PATCH_LEVEL --os_version $OS_VERSION --pagesize $PAGESIZE --ramdisk $RAMDISK --ramdisk_offset $RAMDISK_OFFSET --second_offset $SECOND_OFFSET --tags_offset $TAGS_OFFSET -o $OUTPUT_FILE

          cp build/out/d1/boot.img build/out/d1/zip/files/boot.img
          cp build/out/d1/dtb.img build/out/d1/zip/files/dtb.img
          cp build/out/d1/dtbo.img build/out/d1/zip/files/dtbo.img
          cp build/update-binary build/out/d1/zip/META-INF/com/google/android/update-binary
          cp build/updater-script build/out/d1/zip/META-INF/com/google/android/updater-script

          mkdir tmp
          cp -rp ./build/out/d1/zip/* tmp
          cd tmp
          7za a -mx9 tmp.zip *
          cd ..
          cp -fp tmp/tmp.zip ${{ env.DEVICE_CODENAME }}-${{ env.ROM_TEXT }}-$TIME-${{ env.PACK_METHOD }}.zip
          rm -rf tmp

          echo "PACK_NAME=${{ env.DEVICE_CODENAME }}-${{ env.ROM_TEXT }}-$TIME-${{ env.PACK_METHOD }}.zip" >> $GITHUB_ENV

      - name: âœï¸ Upload Artifacts
        uses: ./.github/workflows/upload-files
